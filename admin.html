<script type="module">
// ==================== SEM PROTE√á√ÉO - ACESSO LIVRE ====================
console.log('üîì Acesso admin liberado');

// Importar API
import api from './api.js';

// Verificar autentica√ß√£o
async function checkAuth() {
    try {
        const data = await api.verify();
        if (!data.user.is_admin) {
            alert('‚ö†Ô∏è Voc√™ n√£o √© administrador!');
            window.location.href = 'index.html';
            return false;
        }
        document.getElementById('user-name').textContent = data.user.name;
        return true;
    } catch (error) {
        // N√£o autenticado - mostrar tela de login
        showLoginScreen();
        return false;
    }
}

// Tela de login (aparece se n√£o estiver logado)
function showLoginScreen() {
    document.querySelector('.main-content').innerHTML = `
        <div style="text-align: center; padding: 50px;">
            <h2>üîê Login Administrativo</h2>
            <p style="color: #666; margin-bottom: 30px;">
                Fa√ßa login com uma conta de administrador
            </p>
            
            <div style="max-width: 350px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <div style="margin-bottom: 20px;">
                    <input type="text" 
                           id="login-phone" 
                           placeholder="Telefone (ex: 11999999999)" 
                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                </div>
                
                <div style="margin-bottom: 25px;">
                    <input type="password" 
                           id="login-password" 
                           placeholder="Senha" 
                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                </div>
                
                <button onclick="doAdminLogin()" 
                        style="width: 100%; padding: 14px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;">
                    <i class="fas fa-sign-in-alt"></i> Entrar como Administrador
                </button>
                
                <div id="login-error" style="color: #dc2626; margin-top: 15px; font-size: 14px; min-height: 20px;"></div>
            </div>
            
            <p style="margin-top: 30px; color: #999; font-size: 14px;">
                Apenas usu√°rios com permiss√£o de administrador podem acessar
            </p>
        </div>
    `;
}

// Fun√ß√£o de login
async function doAdminLogin() {
    const phone = document.getElementById('login-phone').value.trim();
    const password = document.getElementById('login-password').value;
    const errorEl = document.getElementById('login-error');
    
    errorEl.textContent = '';
    
    if (!phone || !password) {
        errorEl.textContent = 'Preencha telefone e senha';
        return;
    }
    
    try {
        const data = await api.login(phone, password);
        
        if (!data.user.is_admin) {
            errorEl.textContent = '‚ùå Este usu√°rio n√£o √© administrador';
            return;
        }
        
        // Login bem sucedido - recarregar p√°gina
        location.reload();
        
    } catch (error) {
        errorEl.textContent = '‚ùå ' + error.message;
    }
}

// Carregar usu√°rios
async function loadUsers() {
    try {
        const users = await api.getUsers();
        const tbody = document.getElementById('users-table-body');
        
        if (users.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px; display: block; color: #ddd;"></i>
                        Nenhum usu√°rio cadastrado<br>
                        <small>Use o bot√£o "Novo Usu√°rio" para come√ßar</small>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = users.map(user => `
            <tr>
                <td>${user.id}</td>
                <td><strong>${user.name}</strong></td>
                <td>${user.phone}</td>
                <td>${user.email}</td>
                <td>
                    <span class="badge ${user.is_admin ? 'badge-admin' : 'badge-user'}">
                        ${user.is_admin ? 'üëë Administrador' : 'üë§ Usu√°rio'}
                    </span>
                </td>
                <td>${new Date(user.created_at).toLocaleDateString('pt-BR')}</td>
                <td class="actions">
                    <button class="btn-secondary" onclick="editUser(${user.id})">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    ${!user.is_admin ? `
                        <button class="btn-danger" onclick="deleteUser(${user.id}, '${user.name.replace(/'/g, "\\'")}')">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    ` : ''}
                </td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Erro ao carregar usu√°rios:', error);
        document.getElementById('users-table-body').innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 30px; color: #dc2626;">
                    <i class="fas fa-exclamation-triangle"></i> Erro ao carregar usu√°rios:<br>
                    <small>${error.message}</small>
                </td>
            </tr>
        `;
    }
}

// Resto do c√≥digo permanece igual...
// ... (c√≥digo de modal, edi√ß√£o, exclus√£o, etc)

// Inicializar
async function init() {
    const isAuthenticated = await checkAuth();
    if (isAuthenticated) {
        loadUsers();
    }
}

// Tornar fun√ß√µes globais
window.doAdminLogin = doAdminLogin;
window.editUser = editUser;
window.deleteUser = deleteUser;

// Iniciar quando p√°gina carregar
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
</script>
